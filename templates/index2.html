<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Risk Map for Microinsurance</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #map-container {
            height: 500px;
            width: 100%;
            border: 2px solid #ccc;
            border-radius: 5px;
        }
        .risk-high {
            color: #f44336;
            font-weight: bold;
        }
        .risk-medium {
            color: #ff9800;
            font-weight: bold;
        }
        .risk-low {
            color: #4caf50;
            font-weight: bold;
        }
        .time-slider-container {
            padding: 10px 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .time-slider {
            width: 100%;
        }
        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }
        .play-button {
            margin-right: 10px;
        }
        .map-controls {
            z-index: 1;
        }
        .map-legend {
            z-index: 1;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        .risk-high.legend-color {
            background-color: #f44336;
        }
        .risk-medium.legend-color {
            background-color: #ff9800;
        }
        .risk-low.legend-color {
            background-color: #4caf50;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Dynamic Risk Map</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">Map</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#alerts">Risk Alerts</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#predictions">Yield Predictions</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#insurance">Insurance Products</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container mt-4 mb-4">
        <h1 class="text-center mb-4">Dynamic Risk Map for Agricultural Microinsurance</h1>
        
        <div class="row mb-3">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        Time Navigation
                    </div>
                    <div class="card-body">
                        <div class="time-slider-container">
                            <div class="d-flex align-items-center mb-2">
                                <button id="play-button" class="btn btn-sm btn-primary play-button">
                                    <i class="fa fa-play"></i> Play
                                </button>
                                <div class="w-100">
                                    <input type="range" class="form-range time-slider" id="time-slider" min="0" max="29" value="0">
                                </div>
                            </div>
                            <div class="slider-labels">
                                <span>Jan 15, 2025</span>
                                <span id="current-date">Jan 15, 2025</span>
                                <span>Feb 14, 2025</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <select id="date-selector" class="form-select">
                                    {% for date in dates %}
                                        <option value="{{ date }}">{{ date }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <select id="risk-type" class="form-select">
                                    <option value="general">General Risk</option>
                                    <option value="drought">Drought Risk</option>
                                    <option value="flood">Flood Risk</option>
                                    <option value="pest">Pest Risk</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <button id="animated-map-btn" class="btn btn-info w-100">
                                    <i class="fa fa-film"></i> View Animated Risk Map
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="map-container" class="mb-4 position-relative">
            <iframe id="map-frame" width="100%" height="100%" frameborder="0"></iframe>
            <div class="map-controls position-absolute top-0 end-0 p-2">
                <button class="btn btn-sm btn-light mb-2" id="zoom-in"><i class="fas fa-search-plus"></i></button>
                <button class="btn btn-sm btn-light mb-2" id="zoom-out"><i class="fas fa-search-minus"></i></button>
                <button class="btn btn-sm btn-light" id="reset-map"><i class="fas fa-sync-alt"></i></button>
            </div>
            <div class="map-legend position-absolute bottom-0 start-0 p-3 bg-dark">
                <h6 class="text-white mb-2">Risk Legend</h6>
                <div class="d-flex flex-column">
                    <div class="d-flex align-items-center mb-1">
                        <div class="legend-color risk-high me-2"></div>
                        <span class="text-white">High Risk</span>
                    </div>
                    <div class="d-flex align-items-center mb-1">
                        <div class="legend-color risk-medium me-2"></div>
                        <span class="text-white">Medium Risk</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="legend-color risk-low me-2"></div>
                        <span class="text-white">Low Risk</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        Dashboard Summary
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-column">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Total Parcels:</span>
                                <span id="total-parcels">Loading...</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>High Risk Areas:</span>
                                <span id="high-risk-areas">Loading...</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Insured Parcels:</span>
                                <span id="insured-parcels">Loading...</span>
                            </div>
                            <div class="crop-metrics mt-3">
                                <h6>Crop Metrics</h6>
                                <div id="crop-metrics-container">
                                    <!-- Crop metrics will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                        <span>Risk Alerts</span>
                        <button class="btn btn-sm btn-light" id="refresh-alerts">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="card-body" id="alerts-container">
                        <div class="alert alert-info" id="no-alerts" style="display: none;">
                            No active alerts at this time.
                        </div>
                        <div id="alerts-list">
                            {% if alerts %}
                                <ul class="list-group">
                                {% for alert in alerts %}
                                    <li class="list-group-item {% if 'HIGH ALERT' in alert.alert %}list-group-item-danger{% else %}list-group-item-warning{% endif %}">
                                        {{ alert.alert }} <small>({{ alert.date }})</small>
                                    </li>
                                {% endfor %}
                                </ul>
                            {% else %}
                                <p>No active alerts at this time.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        Yield Predictions
                    </div>
                    <div class="card-body">
                        <div id="yield-predictions">
                            Loading predictions...
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        Available Microinsurance Products
                    </div>
                    <div class="card-body">
                        <div class="accordion" id="insuranceAccordion">
                            {% for product in insurance_products %}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                                        {{ product.name }}
                                    </button>
                                </h2>
                                <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#insuranceAccordion">
                                    <div class="accordion-body">
                                        <p><strong>Coverage:</strong> Up to ${{ product.coverage }}/ha</p>
                                        <p><strong>Threshold:</strong> {{ product.threshold }}</p>
                                        <p><strong>Minimum Premium:</strong> ${{ product.min_premium }}/ha (varies by risk level)</p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/js/all.min.js"></script>
    <script>
        // Global variables
        let allDates = [];
        let isPlaying = false;
        let animationInterval;
        
        // Load map with default parameters
        function loadMap(date, riskType) {
            const mapFrame = document.getElementById('map-frame');
            mapFrame.src = `/map?date=${date}&risk_type=${riskType}`;
        }
        
        // Load yield predictions for the selected date
        async function loadYieldPredictions(date) {
            try {
                const response = await fetch(`/api/yield_predictions?date=${date}`);
                const predictions = await response.json();
                
                if (predictions.length === 0) {
                    document.getElementById('yield-predictions').innerHTML = '<p>No predictions available for this date.</p>';
                    return;
                }
                
                let html = '<div class="table-responsive">';
                html += '<table class="table table-sm">';
                html += '<thead><tr><th>Parcel ID</th><th>Crop Type</th><th>Predicted Yield (ton/ha)</th><th>Confidence</th><th>Drought Risk</th><th>Flood Risk</th><th>Hail Risk</th></tr></thead>';
                html += '<tbody>';
                
                predictions.forEach(pred => {
                    const confidenceClass = pred.confidence > 70 ? 'bg-success text-white' : 
                                          pred.confidence > 50 ? 'bg-warning' : 'bg-danger text-white';
                    
                    html += `<tr>
                              <td>${pred.parcel_id}</td>
                              <td><strong>${pred.crop || 'Unknown'}</strong></td>
                              <td>${pred.predicted_yield}</td>
                              <td><span class="badge ${confidenceClass}">${pred.confidence}%</span></td>
                              <td>${pred.drought_probability}%</td>
                              <td>${pred.flood_probability}%</td>
                              <td>${pred.hail_probability}%</td>
                             </tr>`;
                });
                
                html += '</tbody></table></div>';
                document.getElementById('yield-predictions').innerHTML = html;
                
            } catch (error) {
                console.error('Error loading yield predictions:', error);
                document.getElementById('yield-predictions').innerHTML = '<p class="text-danger">Error loading predictions.</p>';
            }
        }
        
        // Load risk alerts for the selected date
        async function loadAlerts(date) {
            try {
                const response = await fetch(`/api/risk_data?date=${date}`);
                const data = await response.json();
                
                // Filter alerts (non-null)
                const alerts = data.filter(item => item.alert);
                
                if (alerts.length === 0) {
                    document.getElementById('alerts-list').innerHTML = '<p>No active alerts at this time.</p>';
                    return;
                }
                
                let html = '<ul class="list-group">';
                alerts.forEach(alert => {
                    const alertClass = alert.alert.includes('HIGH ALERT') ? 'list-group-item-danger' : 'list-group-item-warning';
                    html += `<li class="list-group-item ${alertClass}">${alert.alert}</li>`;
                });
                html += '</ul>';
                
                document.getElementById('alerts-list').innerHTML = html;
                
            } catch (error) {
                console.error('Error loading alerts:', error);
                document.getElementById('alerts-list').innerHTML = '<p class="text-danger">Error loading alerts.</p>';
            }
        }
        
        // Fetch and update dashboard summary data
        async function updateDashboardSummary() {
            try {
                const response = await fetch('/api/dashboard_summary');
                if (!response.ok) {
                    throw new Error('Failed to fetch dashboard data');
                }
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Update summary metrics
                document.getElementById('total-parcels').textContent = data.total_parcels || 'N/A';
                document.getElementById('high-risk-areas').textContent = data.high_risk_areas || 'N/A';
                document.getElementById('insured-parcels').textContent = data.insured_parcels || 'N/A';

                // Update crop metrics
                const cropMetricsContainer = document.getElementById('crop-metrics-container');
                cropMetricsContainer.innerHTML = '';

                if (Object.keys(data.crop_metrics).length === 0) {
                    cropMetricsContainer.innerHTML = '<div class="text-muted">No crop data available</div>';
                    return;
                }

                for (const [crop, metrics] of Object.entries(data.crop_metrics)) {
                    const cropMetric = document.createElement('div');
                    cropMetric.className = 'crop-metric mb-3';
                    cropMetric.innerHTML = `
                        <div class="fw-bold">${crop}</div>
                        <div class="d-flex justify-content-between">
                            <span>Average Yield:</span>
                            <span>${metrics.average_yield || 'N/A'} ton/ha</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Drought Risk:</span>
                            <span>${metrics.average_risks.drought || 'N/A'}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Flood Risk:</span>
                            <span>${metrics.average_risks.flood || 'N/A'}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Pest Risk:</span>
                            <span>${metrics.average_risks.pest || 'N/A'}</span>
                        </div>
                    `;
                    cropMetricsContainer.appendChild(cropMetric);
                }
            } catch (error) {
                console.error('Error fetching dashboard summary:', error);
                const cropMetricsContainer = document.getElementById('crop-metrics-container');
                cropMetricsContainer.innerHTML = `<div class="text-danger">Error loading data: ${error.message}</div>`;
            }
        }

        // Enhanced risk alerts functionality
        async function loadRiskAlerts(date) {
            try {
                const response = await fetch(`/api/risk_alerts?date=${date}`);
                const alerts = await response.json();

                const alertsList = document.getElementById('alerts-list');
                const noAlerts = document.getElementById('no-alerts');

                alertsList.innerHTML = '';

                if (alerts.length === 0) {
                    noAlerts.style.display = 'block';
                    return;
                }

                noAlerts.style.display = 'none';
                alerts.forEach(alert => {
                    const alertItem = document.createElement('div');
                    alertItem.className = `alert-item ${alert.severity.toLowerCase()}`;
                    alertItem.innerHTML = `
                        <div class="alert-content">
                            <i class="fas fa-exclamation-triangle alert-icon"></i>
                            ${alert.message}
                        </div>
                        <div class="alert-date">${alert.date}</div>
                    `;
                    alertsList.appendChild(alertItem);
                });
            } catch (error) {
                console.error('Error loading risk alerts:', error);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            const dateSelector = document.getElementById('date-selector');
            const riskTypeSelector = document.getElementById('risk-type');
            const timeSlider = document.getElementById('time-slider');
            const playButton = document.getElementById('play-button');
            const currentDateDisplay = document.getElementById('current-date');
            const animatedMapBtn = document.getElementById('animated-map-btn');
            const zoomInBtn = document.getElementById('zoom-in');
            const zoomOutBtn = document.getElementById('zoom-out');
            const resetMapBtn = document.getElementById('reset-map');
            
            // Collect all available dates from the selector
            Array.from(dateSelector.options).forEach(option => {
                allDates.push(option.value);
            });
            
            // Set max value for slider based on number of dates
            if (allDates.length > 0) {
                timeSlider.max = allDates.length - 1;
            }
            
            // Load initial map
            loadMap(dateSelector.value, riskTypeSelector.value);
            loadYieldPredictions(dateSelector.value);
            loadAlerts(dateSelector.value);
            updateCurrentDateDisplay(dateSelector.value);
            updateDashboardSummary();
            
            // Update when date changes from dropdown
            dateSelector.addEventListener('change', function() {
                // Update slider position to match selected date
                const dateIndex = allDates.indexOf(this.value);
                if (dateIndex !== -1) {
                    timeSlider.value = dateIndex;
                }
                
                loadMap(this.value, riskTypeSelector.value);
                loadYieldPredictions(this.value);
                loadAlerts(this.value);
                updateCurrentDateDisplay(this.value);
            });
            
            // Update when slider changes
            timeSlider.addEventListener('input', function() {
                const selectedDate = allDates[this.value];
                if (selectedDate) {
                    // Update dropdown to match slider
                    dateSelector.value = selectedDate;
                    
                    loadMap(selectedDate, riskTypeSelector.value);
                    loadYieldPredictions(selectedDate);
                    loadAlerts(selectedDate);
                    updateCurrentDateDisplay(selectedDate);
                }
            });
            
            // Play/Pause animation
            playButton.addEventListener('click', function() {
                if (isPlaying) {
                    // Stop animation
                    clearInterval(animationInterval);
                    this.innerHTML = '<i class="fa fa-play"></i> Play';
                    isPlaying = false;
                } else {
                    // Start animation
                    this.innerHTML = '<i class="fa fa-pause"></i> Pause';
                    isPlaying = true;
                    
                    animationInterval = setInterval(() => {
                        let currentValue = parseInt(timeSlider.value);
                        const maxValue = parseInt(timeSlider.max);
                        
                        // Increment and loop if needed
                        currentValue = (currentValue >= maxValue) ? 0 : currentValue + 1;
                        
                        // Update slider value
                        timeSlider.value = currentValue;
                        
                        // Trigger the same actions as manual sliding
                        const selectedDate = allDates[currentValue];
                        if (selectedDate) {
                            dateSelector.value = selectedDate;
                            loadMap(selectedDate, riskTypeSelector.value);
                            loadYieldPredictions(selectedDate);
                            loadAlerts(selectedDate);
                            updateCurrentDateDisplay(selectedDate);
                        }
                    }, 1500); // Advance every 1.5 seconds
                }
            });
            
            // Update when risk type changes
            riskTypeSelector.addEventListener('change', function() {
                loadMap(dateSelector.value, this.value);
            });
            
            // Handle animated map button click
            animatedMapBtn.addEventListener('click', function() {
                const riskType = riskTypeSelector.value;
                // Open animated map in a new window
                window.open(`/animated_map?risk_type=${riskType}`, '_blank');
            });
            
            // Map controls
            zoomInBtn.addEventListener('click', function() {
                const mapFrame = document.getElementById('map-frame');
                mapFrame.contentWindow.postMessage({ action: 'zoomIn' }, '*');
            });
            
            zoomOutBtn.addEventListener('click', function() {
                const mapFrame = document.getElementById('map-frame');
                mapFrame.contentWindow.postMessage({ action: 'zoomOut' }, '*');
            });
            
            resetMapBtn.addEventListener('click', function() {
                const mapFrame = document.getElementById('map-frame');
                mapFrame.contentWindow.postMessage({ action: 'resetMap' }, '*');
            });
            
            // Helper function to update the current date display
            function updateCurrentDateDisplay(dateString) {
                // Convert YYYY-MM-DD to more readable format
                const date = new Date(dateString);
                const options = { month: 'short', day: 'numeric', year: 'numeric' };
                currentDateDisplay.textContent = date.toLocaleDateString('en-US', options);
            }
            
            document.getElementById('refresh-alerts').addEventListener('click', function() {
                const currentDate = document.getElementById('date-selector').value;
                loadRiskAlerts(currentDate);
            });
        });
    </script>
</body>
</html>